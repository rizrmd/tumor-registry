"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1956],{6986:function(e,t,o){o.r(t),o.d(t,{AuthProvider:function(){return u},useAuth:function(){return l}});var r=o(7437),n=o(2265),s=o(905);let a=(0,n.createContext)(void 0),l=()=>{let e=(0,n.useContext)(a);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e},i="token",c="passwordVersion",u=e=>{let{children:t}=e,[o,l]=(0,n.useState)(null),[u,d]=(0,n.useState)(!0),[g,h]=(0,n.useState)(!1),v=(0,n.useRef)(null);!function(){let e=(0,n.useRef)(null);(0,n.useEffect)(()=>{let t=async()=>{let e=s.Z.getToken();if(e&&s.Z.isTokenExpiringSoon(e)){console.log("[Token Refresh] Token expiring soon, refreshing...");try{await s.Z.refreshAccessToken()?console.log("[Token Refresh] Token refreshed successfully"):console.log("[Token Refresh] Failed to refresh token, user will be logged out")}catch(e){console.error("[Token Refresh] Error refreshing token:",e)}}};return t(),e.current=setInterval(()=>{t()},6e4),()=>{e.current&&clearInterval(e.current)}},[]),(0,n.useEffect)(()=>{let e;let t=async()=>{let e=s.Z.getToken();e&&s.Z.isTokenExpiringSoon(e)&&(console.log("[Token Refresh] User activity detected, refreshing expiring token..."),await s.Z.refreshAccessToken())},o=()=>{clearTimeout(e),e=setTimeout(t,2e3)};return window.addEventListener("mousemove",o),window.addEventListener("keydown",o),window.addEventListener("click",o),()=>{clearTimeout(e),window.removeEventListener("mousemove",o),window.removeEventListener("keydown",o),window.removeEventListener("click",o)}},[])}();let f=(0,n.useCallback)(()=>{s.Z.logout(),l(null),h(!1),localStorage.removeItem(c)},[]),w=(0,n.useCallback)(async()=>{try{if(!localStorage.getItem(i))return!1;let e=localStorage.getItem(c);if(!e)return!0;let t=await s.Z.getProfile(),o=t.updatedAt?new Date(t.updatedAt).getTime():null,r=parseInt(e,10);if(o&&o!==r)return console.warn("[Auth] Password version mismatch - password changed on server"),f(),!1;return!0}catch(r){var e,t,o;if((null===(e=r.message)||void 0===e?void 0:e.includes("Network Error"))||(null===(t=r.message)||void 0===t?void 0:t.includes("timeout")))return console.log("[Auth] Offline mode - skipping password version check"),!0;if((null===(o=r.response)||void 0===o?void 0:o.status)===401)return console.warn("[Auth] Token invalid - password may have changed"),f(),!1;return console.error("[Auth] Error checking password version:",r),!0}},[f]);(0,n.useEffect)(()=>{(async()=>{try{if(localStorage.getItem(i))try{let e=await s.Z.getProfile();l(e),h(!0),e.updatedAt&&localStorage.setItem(c,new Date(e.updatedAt).getTime().toString())}catch(s){var e,t,o,r;if((null===(e=s.response)||void 0===e?void 0:e.status)===401&&(null===(r=s.response)||void 0===r?void 0:null===(o=r.data)||void 0===o?void 0:null===(t=o.message)||void 0===t?void 0:t.includes("Password changed"))){console.warn("[Auth] Password changed on server - forcing logout"),f();return}console.warn("[Auth] API not available, using cached user:",s);let n=localStorage.getItem("user");if(n)try{let e=JSON.parse(n);l(e),h(!0)}catch(e){f()}else f()}else d(!1)}catch(e){console.error("[Auth] Auth check failed:",e),l(null),h(!1)}finally{d(!1)}})()},[f]),(0,n.useEffect)(()=>{if(!g)return;let e=setInterval(()=>{navigator.onLine&&w()},12e4);v.current=e;let t=()=>{console.log("[Auth] Connection restored - checking password version"),w()};return window.addEventListener("online",t),()=>{clearInterval(e),window.removeEventListener("online",t),v.current=null}},[g,w]);let m=async(e,t,o)=>{d(!0);try{let o=await s.Z.login({email:e,password:t});l(o.user),h(!0);let r=await s.Z.getProfile();r.updatedAt&&localStorage.setItem(c,new Date(r.updatedAt).getTime().toString())}catch(e){throw console.error("[Auth] Login error:",e),e}finally{d(!1)}},p=async e=>{d(!0);try{console.log("[Auth] Registration successful:",e)}catch(e){throw console.error("[Auth] Registration error:",e),e}finally{d(!1)}},k=async()=>{try{let e=await s.Z.getProfile();l(e),h(!0),e.updatedAt&&localStorage.setItem(c,new Date(e.updatedAt).getTime().toString())}catch(n){var e,t,o,r;throw console.error("[Auth] Token refresh error:",n),(null===(e=n.response)||void 0===e?void 0:e.status)===401&&(null===(r=n.response)||void 0===r?void 0:null===(o=r.data)||void 0===o?void 0:null===(t=o.message)||void 0===t?void 0:t.includes("Password changed"))&&console.warn("[Auth] Password changed - forcing logout"),f(),n}},A=async e=>{try{console.log("[Auth] Email verification:",e)}catch(e){throw console.error("[Auth] Email verification error:",e),e}};return(0,r.jsx)(a.Provider,{value:{user:o,isLoading:u,isAuthenticated:g,login:m,register:p,logout:f,refreshToken:k,verifyEmail:A,checkPasswordVersion:w},children:t})}},6383:function(e,t,o){var r,n,s=o(4829);let a=""!=="http://127.0.0.1:3001/api".trim()?"http://127.0.0.1:3001/api":(null===(n=window.go)||void 0===n?void 0:null===(r=n.main)||void 0===r?void 0:r.App)||!window.wails?(console.log("[API] Running in Wails/desktop mode, using localhost API"),"http://127.0.0.1:3001/api/v1"):"/api/v1";console.log("[API] Base URL:",a);let l=s.Z.create({baseURL:a,timeout:3e4,headers:{"Content-Type":"application/json"}});l.interceptors.request.use(e=>{let t=localStorage.getItem("token");return t&&e.headers&&(e.headers.Authorization="Bearer ".concat(t)),e},e=>Promise.reject(e)),l.interceptors.response.use(e=>e,e=>{if(e.response){var t,o;let r=e.response.status,n=e.response.data;401===r||400===r&&(null==n?void 0:null===(o=n.error)||void 0===o?void 0:null===(t=o.details)||void 0===t?void 0:t.some(e=>{var t;return"Unauthorized"===e.message||(null===(t=e.message)||void 0===t?void 0:t.includes("token"))}))?(localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.pathname.includes("/login")||(window.location.href="/login")):403===r?console.error("Access forbidden"):404===r?console.error("Resource not found"):r>=500&&console.error("Server error occurred")}else e.request?console.error("Network error - no response from server"):console.error("Error setting up request:",e.message);return Promise.reject(e)}),t.Z=l},905:function(e,t,o){var r=o(6383);class n{async login(e){let t=await r.Z.post("/auth/login",e);return t.data.accessToken&&(localStorage.setItem("token",t.data.accessToken),localStorage.setItem("refreshToken",t.data.refreshToken),localStorage.setItem("user",JSON.stringify(t.data.user))),t.data}logout(){localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.location.href="/login"}getCurrentUser(){let e=localStorage.getItem("user");if(e)try{return JSON.parse(e)}catch(e){console.error("Error parsing user from localStorage:",e)}return null}isAuthenticated(){return!!localStorage.getItem("token")}getToken(){return localStorage.getItem("token")}async getProfile(){return(await r.Z.get("/auth/profile")).data}async refreshAccessToken(){try{let e=localStorage.getItem("refreshToken");if(!e)return null;let t=await r.Z.post("/auth/refresh-token",{refreshToken:e});return t.data.accessToken&&(localStorage.setItem("token",t.data.accessToken),localStorage.setItem("refreshToken",t.data.refreshToken)),t.data}catch(e){return console.error("Failed to refresh token:",e),this.logout(),null}}getTokenExpiration(e){try{let t=JSON.parse(atob(e.split(".")[1]));return t.exp?1e3*t.exp:null}catch(e){return console.error("Failed to decode token:",e),null}}isTokenExpiringSoon(e){let t=this.getTokenExpiration(e);return!t||t-Date.now()<3e5}async changePassword(e,t){await r.Z.post("/auth/change-password",{oldPassword:e,newPassword:t})}}t.Z=new n}}]);