name: Build Desktop Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux/amd64
            name: tumor-registry-linux
          - os: macos-latest
            platform: darwin/universal
            name: tumor-registry-macos
          - os: windows-latest
            platform: windows/amd64
            name: tumor-registry-windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: bun install

      - name: Build frontend
        working-directory: ./frontend
        run: bun run build
        env:
          NEXT_PUBLIC_STATIC_EXPORT: "true"

      - name: Build backend
        working-directory: ./backend
        run: |
          bun install
          bun run build

      - name: Copy backend source to desktop resources (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p desktop/resources/backend
          rsync -av --exclude='node_modules' --exclude='dist' --exclude='dist_user' backend/ desktop/resources/backend/
          rm -rf desktop/resources/backend/node_modules
          echo "Backend source copied to desktop/resources/backend"

      - name: Copy backend source to desktop resources (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path desktop/resources/backend
          Copy-Item -Path backend/* -Destination desktop/resources/backend -Recurse -Force
          Exclude-Item desktop/resources/backend/node_modules -Recurse -ErrorAction SilentlyContinue
          Remove-Item desktop/resources/backend/node_modules -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item desktop/resources/backend/dist -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item desktop/resources/backend/dist_user -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Backend source copied to desktop/resources/backend"

      - name: Sync frontend to desktop
        run: bun scripts/sync-frontend.js

      - name: Build Wails app
        working-directory: ./desktop
        run: wails build -clean

      - name: Sign macOS app (ad-hoc)
        if: runner.os == 'macOS'
        run: |
          codesign --force --deep --sign - desktop/build/bin/INAMSOS.app
          codesign --verify --verbose desktop/build/bin/INAMSOS.app

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: desktop/build/bin/*
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
